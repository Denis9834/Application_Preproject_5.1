name: Deploy Workflow

on:
  push: 
    branches: 
      - master

env:
  IMAGE_NAME: denis9834/application_5
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  SERVER_IP: ${{ secrets.SERVER_IP }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD
      
      - name: Build and push Docher Hub
        run: |
          docker build -t $IMAGE_NAME:latest .
          docker push  $IMAGE_NAME:latest

      - name: Copy docker-compose.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: $SERVER_IP
          username: $SERVER_USER
          key: $SSH_PRIVATE_KEY
          source: "docker-compose.yml"
          target: "/home/$SERVER_USER/myProject"

      - name: Deploy application
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: $SERVER_IP
          username: $SERVER_USER
          key: $SSH_PRIVATE_KEY
          script: |
            cd /home/$SERVER_USER/myProject
            docker pull $IMAGE_NAME:latest
            docker-compose -f /home/$SERVER_USER/myProject/docker-compose.yml down
            docker-compose -f /home/$SERVER_USER/myProject/docker-compose.yml up -d --build
            docker system prune -af
